<html>

<!-- Mirrored from www.cprogramming.com/tutorial/operator_new.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 23:36:06 GMT -->
<head>
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds2.feedburner.com/Cprogrammingcom/">
<link rel="stylesheet" href="http://static.cprogramming.com/main_images/style.css?np9" type="text/css">
<!--[if IE]>
    <link rel="stylesheet" href="http://static.cprogramming.com/main_images/style-ie.css?np4" type="text/css">
<![endif]-->


<META NAME="keywords" CONTENT="operator new, placement new, operator delete, C++ memory management">
<META NAME="Description" CONTENT="How and why to overload operator new (and operator delete) in C++">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Operator New and Operator Delete in C++ - Cprogramming.com</title>

<!-- ADDED DFP -->
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'>
</script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-2560316224908115");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-2560316224908115", "RunOfSite_LargeRectangle_ATF_336x280");
GA_googleAddSlot("ca-pub-2560316224908115", "RunOfSite_ATF_leaderboard_728x90");

</script>
<script type='text/javascript'>
GA_googleFetchAds();
</script>
<!-- END ADDED DFP -->


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7820175-1']);
  _gaq.push(['_setDomainName', '.cprogramming.com']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</head>

<body>
<div>

<a href="../index.html"><img class="logo noprint" src="http://static.cprogramming.com/main_images/title.png" width="324" height="83" border="0"></a> 

<table class="line noprint"><tr><td></td></tr></table>
<div class="noprint" align="right" style="padding-top:25px;padding-right:25px;">
<!-- SiteSearch Google -->
<form action="http://www.google.com/cse" id="cse-search-box">
  <div>
    <input type="hidden" name="cx" value="partner-pub-2560316224908115:wqvdce-aw4a" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="31" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<!-- SiteSearch Google -->
</div>
<div>
  <table class="main">
    <tr>

  	<td class="noprint" colspan="5" bgcolor="#EBEBEB">
  		<img src="http://static.cprogramming.com/main_images/spacer-vert.png" height="6" width="0">
  	   <center>
    	<div class="leaderboard">

<!-- ADDED DFP -->
<!-- ca-pub-2560316224908115/Homepage_ATF_leaderboard_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("RunOfSite_ATF_leaderboard_728x90");
</script>
<!-- END ADDED DFP -->

</div>
		</center>
		<img src="http://static.cprogramming.com/main_images/spacer-vert.png" height="4" width="1">
  	</td>
        
  </tr>

  <tr>

     <td class="noprint" width="130" valign="top" bgcolor="#EBEBEB"> 
     <div class="menu" valign="top" style="font-size:14px;width:200px">
     <p class="navcategory" align="left">
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14">    Starting out
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
             <a href="../c%2b%2bbook/index5969.html?inl=sb">Get the Ebook</a><br>
             <a href="../begin.html">Get Started with C or C++</a><br>
             <a href="../compilers.html">Getting a Compiler</a><br>
             <a href="../books.html">Book Recommendations</a><br>
     </p>

     <p class="navcategory" align="left">
          <br>
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14"> Tutorials
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
            <a href=c-tutorial.html>C Tutorial</a><br>
            <a href=c%2b%2b-tutorial.html>C++ Tutorial</a><br>
            <a href=../java-programming.html>Java Tutorial</a><br>
            <a href=../game-programming.html>Game Programming</a><br>
            <a href=../graphics-programming.html>Graphics Programming</a><br>
            <a href=../algorithms-and-data-structures.html>Algorithms &amp; Data Structures</a><br>
            <a href=../debuggers.html>Debugging</a><br>
            <a href="../tutorial.html">All Tutorials</a><br>
     </p>

     <p class="navcategory" align="left">
          <br>
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14"> Practice
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
            <a href="../challenge.html">Practice Problems</a><br>
            <a href="../quiz/index.html">Quizzes</a><br>
     </p>
     <p class="navcategory" align="left">
          <br>
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14"> Resources
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
            <a href="../cgi-bin/source/source.html">Source Code</a><br>
            <a href=../snippets/index.html>Source Code Snippets</a><br>
            <a href="../tips/index.html">C and C++ Tips</a><br>
            <a href=../jobs/index.html>Finding a Job</a>
     </p>

     <p class="navcategory" align="left">
          <br>
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14"> References
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
            <a href="../function.html">Function Reference</a><br>
            <a href="../reference/index.html">Syntax Reference</a><br>
            <a href="../cgi-bin/cdir/Cdirectory.html">Programming Links</a><br>
            <a href="http://faq.cprogramming.com/cgi-bin/smartfaq.cgi">Programming FAQ</a><br>
     </p>

     <p class="navcategory" align="left">
          <br>
          <img class="bullet" src="http://static.cprogramming.com/main_images/bullet.gif" width="11" height="14"> Getting Help
     </p>

     <p class="navlist" align="left" style="font-size:14px;">
             <a href="../board.html">Message Board</a><br>
             <a href="../expert.html">Ask an Expert</a><br>
             <a href="../email.html">Email</a><br>
             <a href="../about.html">About Us</a>
     </p>
     </div>

<center>
      <br><br>
     <script type="text/javascript"><!--
     google_ad_client = "pub-2560316224908115";
     google_ad_width = 120;
     google_ad_height = 90;
     google_ad_format = "120x90_0ads_al";
     google_ad_channel ="0800879710";
     google_color_border = "EBEBEB";
     google_color_bg = "EBEBEB";
     google_color_link = "C30000";
     google_color_url = "C30000";
     google_color_text = "000000";
     //--></script>
     <script type="text/javascript"
       src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
       </script>
</center>



    </td>
	<td class="content" valign="top">

    			<div class="content2">

<h1>Customized Allocators with Operator New and Operator Delete</h1>



by Andrei Milea
<h2>Why Customize Memory Allocation by Overloading New and Delete?</h2>

At times, you will have classes for which you want to specialize memory
allocation.  Why?  You know something about how the class is used.

        For instance, you might specialize memory allocation for a class in
        order to squeeze some extra
        performance out of your program. Suppose you have a <a href="lesson15.html">linked
        list</a> and 

you want to speed up the allocation of new nodes. One way to do this is to
maintain a list of deleted nodes, whose memory can be reused when new nodes
are allocated. Instead of using 
the default new and delete, new will be overloaded to try to get a node from
the list of deleted nodes; only if no deleted nodes are available would it
dynamically allocate memory.   Delete will simply add the 
node to the deleted nodes.   This way instead of allocating new memory from the heap (which is pretty time consuming) we will 
use the already allocated space. The technique is usually called caching.<br><br>
Another useful reimplementation of new/delete operators is to provide <a href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">garbage collection</a> for your objects.  That is, you can 
implement a garbage collector similar to the one that Java or C# uses so your
objects will be deleted automatically when they are no longer used.  (You
        might wonder why you need to provide your own allocator to write a
        garbage collector.
        <br><br>
One more example usage  is creating an <a href="http://www.cs.lth.se/EDA150/wA3.html">arena allocator</a> that makes
memory allocations and deallocations lightning fast at the cost of temporarily
holding on to more memory than necessary by allocating a large block up front
and then carving out one piece at a time.
<br><br>
In order to specialize allocation, you overload <b>operator new</b> and
<b>operator delete</b>.  (For more on operator overloading, see <a href="operator_overloading.html">introduction
    to operator
    overloading</a>.)
Operator new is used to perform all memory allocation when the new keyword is
used, and operator delete is used to deallocate that memory when delete is
used.  As with the rest of the operators, new and delete can be overloaded to
    specialize them for a specific class.  But first, let's clarify the exact
    distinction between operator new and the new keyword.

<center>
<div class='noprint'>
<!-- RunOfSite_LargeRectangle_ATF_336x280 -->
<script type='text/javascript'>
GA_googleFillSlot('RunOfSite_LargeRectangle_ATF_336x280');
</script>
</div>


</center>
<h3>The relationship between Operator New and the New Keyword</h3>

Don't be confused by the fact that there is both a <b>new</b> keyword and an
<b>operator new</b>.  When you write:

<pre class="example">
MyClass *x = new MyClass;
</pre>

there are actually two things that happen--memory allocation and object
construction; the new keyword is responsible for both.  One step in the
process is to call <b>operator new</b> in order to allocate memory; the other
step is to actually invoke the constructor.  Operator new lets you change the
memory allocation method, but does not have any responsibility for calling the
constructor.  That's the job of the new keyword.
<br><br>
As it turns out, it is actually possible to invoke the constructor without
calling operator new.  That's the job of <b>placement new</b> (covered below).

<h2>Changing the default behavior of new and delete</h2>

Here's an example of what it would look like to overload new and delete for a
particular class.
<pre class="example">
class Myclass
{
public:
        void* operator new(size_t);
        void operator delete(void*);
};
</pre>
Both of them are by default <a href="statickeyword.html">static</a> members and do not maintain a this pointer. Overloading can be used for many purposes.  For 
example, we may need to alter the <a href="exceptions.html">exception</a> thrown
in case of failure--<a href="http://www2.roguewave.com/support/docs/leif/sourcepro/html/stdlibref/bad-alloc.html">std::bad_alloc</a>--and throw something else:
<pre class="example">
void* Myclass::operator new(size_t size)
{
    void *storage = malloc(size);
    if(NULL == storage) {
            throw "allocation fail : no free memory";
    }
}
</pre>



Usually we do this in a base class in order to have the functionality of the overloaded new in all derived classes. Implicitly the definition of new is included in every file, but in order to use the size_t declaration and other new related types you 

must include the header &lt;new&gt; .<br><br>
The new operator can be implemented using <a href="http://www.cplusplus.com/reference/clibrary/cstdlib/malloc/">malloc</a> or
another C function, called <a href="http://www.cplusplus.com/reference/clibrary/cstdlib/realloc/">realloc</a>, that handles memory allocation:
<pre class="example">
void * realloc ( void * ptr, size_t size );
</pre>
This can be used to change the size of the allocated block at address ptr with the size given in the second parameter. The 

address pointed to by ptr can actually be changed and the block moved someplace else, in which case the new address will be the 

returned value.  If realloc fails, like malloc, it returns NULL.  But realloc will
not free the original memory if your memory allocation request fails.
Therefore, when you use
realloc, be sure to save the previous pointer value in case allocation fails,
    so that you do not leak memory.
<br><br>
Note that in general, if you overload new, you will likely need to overload
delete, and vice versa, because by changing how you allocate memory, you will
typically also change how you free memory.
<br><br>
Operator new is invoked implicitly when new is called; there is no syntax for
calling operator new explicitly.


<h2>Placement New</h2>
Standard C++ also supports a second version of new, called placement new, which constructs an object on a preallocated  
storage. In order for this to work we must provide the address where we want the object to be allocated as a pointer 
parameter:
<pre class="example">(my_class = new (place) Myclass);
</pre>

So why would you want to use placement new?  Placement new is useful for constructing objects in a pre-allocated block of
memory.  This bypasses the work of operator new by allowing the person
constructing the object to choose the memory that it is initialized into.  You
might do this if you have a pool of memory you want to use for constructing
some objects of a class, but don't want to overload operator new for the whole
class.<br><br><b>Related articles</b>
<br><br><a href="operator_overloading.html">Operator
overloading</a><br><br><a href="../cgi-bin/memory_quiz/quiz.html">Quiz on Memory
Allocation and Management</a>
<br><br><a href="lesson6.html">Understanding
Pointers in C++</a>
<br><br><a href="dynamic_memory_allocation.html">Dynamic
Memory Allocation, Part 1: Advanced Memory Management</a><br><br><a href="virtual_memory_and_heaps.html">Dynamic
Memory Allocation, Part 2: Dynamic Memory Allocation and Virtual
Memory</a><br><br><a href="c%2b%2b_memory_problems.html">Dynamic
Memory Allocation, Part 4: Common Memory Management Problems in
C++</a>

<div id="footer" class="noprint">

<div id="social" style="margin-top:5px;height:23px;">
<table>
<tr>
<td> 
<div id="fb-root"></div>
<div id="fb-recommend" class="fb-like" data-send="false" data-width="120" data-height="21" data-layout="button_count" data-action="recommend"></div>
</td>
<td>
<a class="twitter-share-button" data-count="horizontal" data-via="alexallain"></a>
</td>
<td>
<div class="g-plusone" data-size="medium"></div>
</td>
</tr>
</table>
</div>

<div style="font-size:14px;padding:10px;margin-top:5px;margin-bottom:5px;">
<div style="width:400px;margin-top:5px">
<div style="float:left"><a href=../c%2b%2bbook/index65a0.html?inl=ft-nhp><img src=../c%2b%2bbook/small_3d.jpg border=0></a></div>Want to become a C++ programmer? The Cprogramming.com ebook, Jumping into C++, will walk you through it, step-by-step. <a href=../c%2b%2bbook/index65a0.html?inl=ft-nhp>Get Jumping into C++ today!</a>
</div>
<div style="clear: both"></div>

<b>Popular pages</b>
<ul>
 <li><a href=../begin.html>Exactly how to get started with C++ (or C) today</a> 
<li><a href=c-tutorial.html>C Tutorial</a>
<li><a href=c%2b%2b-tutorial.html>C++ Tutorial</a>
<li><a href=../how_to_learn_to_program.html>5 ways you can learn to program faster</a> 
<li><a href=../beginner_programming_mistakes.html>The 5 Most Common Problems New Programmers Face</a>
<li><a href=../code_blocks/index.html>How to set up a compiler</a>
<li><a href=common.html>8 Common programming Mistakes</a> 
<li><a href=../c%2b%2b11/what-is-c%2b%2b0x.html>What is C++11?</a>
<li><a href=game_programming/same_game_part1.html>How to make a game in 48 hours</a>
</ul>

<b>Recent additions</b> <a href="http://feeds2.feedburner.com/Cprogrammingcom" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="subscribe to a feed" style="border:0" width="16" height="16"></img></a>
<ul>
<li><a href=shared-libraries-linux-gcc.html>How to create a shared library on Linux with GCC</a> - December 30, 2011</li>
<li> <a href="../c%2b%2b11/c%2b%2b11-nullptr-strongly-typed-enum-class.html">Enum classes and nullptr in C++11</a> - November 27, 2011</li>
<li><a href="computersciencetheory/hash-table.html">Learn about The Hash Table</a> - November 20, 2011</li>
<li><a href="../c%2b%2b11/rvalue-references-and-move-semantics-in-c%2b%2b11.html">Rvalue References and Move Semantics in C++11</a> - November 13, 2011</li>
<li><a href="../java/c-and-c%2b%2b-for-java-programmers.html">C and C++ for Java Programmers</a> - November 5, 2011</li>
<li><a href="c%2b%2b-iostreams.html">A Gentle Introduction to C++ IO Streams</a> - October 10, 2011</li>
</ul>

</div>
<style type="text/css">
@import url(http://www.google.com/cse/api/branding.css);
</style>
<div class="cse-branding-bottom" style="background-color:#FFFFFF;color:#000000;width:50%; margin:auto">
  <div class="cse-branding-form">
    <form action="http://www.google.com/cse" id="cse-search-box">
      <div>
        <input type="hidden" name="cx" value="partner-pub-2560316224908115:0581759109" />
        <input type="hidden" name="ie" value="UTF-8" />
        <input type="text" name="q" size="55" />
        <input type="submit" name="sa" value="Search" />
      </div>
    </form>
  </div>
  <div class="cse-branding-logo">
    <img src="http://www.google.com/images/poweredby_transparent/poweredby_FFFFFF.gif" alt="Google" />
  </div>
  <div class="cse-branding-text">
    Custom Search
  </div>
</div>

<center>
<div style="margin-top:20px; margin-bottom: 20px">
<script type="text/javascript">
<!--
google_ad_client = "pub-2560316224908115";
/* link_ads_bottom */
google_ad_slot = "2258412831";
google_ad_width = 728;
google_ad_height = 15;
//-->
</script> 
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script> 
</div>
 
<script type="text/javascript" src="http://forms.aweber.com/form/12/618210012.js"></script>

<div class="footer-links" style="padding:10px">
<a href="../advertising.html">Advertising</a> | <a href="../privacy.html">Privacy policy</a> |
<a href="../use.html">Copyright © 1997-2011 Cprogramming.com. All rights reserved.</a> | <a href=mailto:webmaster@cprogramming.com>webmaster@cprogramming.com</a>
</div>
</div>
</div>
</td>
    	


<td class="content noprint" valign="top" rowspan="1" bgcolor="#EBEBEB">
<div class="content2"><br><div class="verticalad">







<script type="text/javascript"><!--
        e9 = new Object();
    e9.size = "160x600,120x600";
//--></script>
<script type="text/javascript" src="http://tags.expo9.exponential.com/tags/Cprogrammingcom/ROS/tags.js"></script>



</div><br>

<style type="text/css">
.sidebar-box { width: 150px; margin-bottom:5px; }
</style>
    <div id="side-images">
        <div style="padding:5px;margin-top:5px">
            <div style="margin-bottom: 5px">
                <b>Popular pages</b>
            </div>
            <div>
                
                <!--http://www.flickr.com/photos/baslow/5620208/sizes/o/in/photostream/ -->
                <div class = "sidebar-box">
                    <a href=c-tutorial.html>
                    <img src=http://static.cprogramming.com/main_images/footer/5620208_bff9c514e6_s.jpg border=0 height=75 width=75 alt="C tutorial">
                    <br>
                    C Tutorial
                    </a>
                </div>
                

                
                <!--http://www.flickr.com/photos/29233640@N07/2855530649/sizes/sq/in/photostream/-->
                <div class = "sidebar-box">
                    <a href=../begin.html>
                    <img src=http://static.cprogramming.com/main_images/footer/2855530649_905f7862fd_s.jpg border=0 height=75 width=75 alt="Get started">
                    <br>
                    Exactly how to get started with C++ (or C) today</a>
                </div>
                

                
                <!--http://www.flickr.com/photos/mikecogh/6505012533/sizes/sq/in/photostream/-->
                <div class = "sidebar-box">
                    <a href=../how_to_learn_to_program.html>
                    <img src=http://static.cprogramming.com/main_images/footer/6505012533_55c83fdfa0_s.jpg border=0 height=75 width=75 alt="Learn to program">
                    <br>
                    5 ways you can learn to program faster</a>
                </div>
                

                
                <div class = "sidebar-box">
                    <a href=c%2b%2b-tutorial.html>
                    <img src=http://static.cprogramming.com/main_images/footer/c++-img.png border=0 height=75 width=75 alt="C++ tutorial">
                    <br>
                    C++ Tutorial</a>
                </div>
                

                
                <!--http://www.flickr.com/photos/giopuo/3441263816/sizes/sq/in/photostream/-->
                <div class = "sidebar-box">
                    <a href=../beginner_programming_mistakes.html>
                    <img src=http://static.cprogramming.com/main_images/footer/3441263816_95f132a884_s.jpg border=0 height=75 width=75 alt="Problems new programmers face">
                    <br>
                    The 5 Most Common Problems New Programmers Face</a>
                </div>
                

                
                <div class = "sidebar-box">
                   <a href=game_programming/same_game_part1.html>
                    <img src=game_programming/same_game_small.png border=0 height=42 width=42 alt="Learn to make a game">
                    <br>
                   How to make a game in 48 hours</a>
                </div>
                

                
                <div class = "sidebar-box">
                   <a href=common.html>
                    <img src=http://static.cprogramming.com/main_images/footer/2291127824_087a497bea_s.jpg border=0 height=75 width=75 alt="Common problems">
                    <br>
                   8 Common Programming Mistakes</a>
                </div>
                

                
                <div class = "sidebar-box">
                   <a href=../c%2b%2b11/what-is-c%2b%2b0x.html>
                    <img src=http://static.cprogramming.com/main_images/footer/c++11.png border=0 height=75 width=75 alt="C++11">
                    <br>
                   What is C++11?</a>
                </div>
                
            </div>
        </div>
        <div style="display:block">
            <a href=../image_credits.html>Image credits</a>
        </div>
    </div>
</div>
</td>  	

</tr>
</table>
</div>


<script>
(function(w, d, s) {
  var cur_url = window.location;
  var loc = cur_url;
  if ( /htm(l?)/.test( cur_url.pathname ) ) {
    loc = cur_url.protocol + "//" + cur_url.host + cur_url.pathname.replace( /\+/g, "%2b" );
  }
  d.getElementById( "fb-recommend" ).setAttribute( "data-href", loc );
  function go(){
    var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
          if (d.getElementById(id)) {return;}
          js = d.createElement(s); js.src = url; js.id = id;
          fjs.parentNode.insertBefore(js, fjs);
        };
    load('http://connect.facebook.net/en_US/all.js#xfbml=1&channelUrl=http%3A%2F%2Fwww.cprogramming.com%2Ffb%2Fchannel.html', 'fbjssdk');
    load('https://apis.google.com/js/plusone.js', 'gplus1js');
    load('http://platform.twitter.com/widgets.js', 'tweetjs');
  }
  if (w.addEventListener) { w.addEventListener("load", go, false); }
  else if (w.attachEvent) { w.attachEvent("onload",go); }
}(window, document, 'script'));
</script>


</body>

<!-- Mirrored from www.cprogramming.com/tutorial/operator_new.html by HTTrack Website Copier/3.x [XR&CO'2010], Mon, 10 Sep 2012 23:36:06 GMT -->
</html>



